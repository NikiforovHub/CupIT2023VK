# Ранжирование комментариев к постам. Кейс от Changellenge и VK

## Постановка задачи
Есть посты и комментарии к ним. Для каждого поста в трейновом датасете указан рейтинг каждого комментария к посту, эти рейтинги принимают значения от 0 до n, где 0 -- самый лучший комментарий. 
Необходимо при помощи трейнового датасета научиться предсказывать рейтинги комментариев для тестового датасета.

## Подробный разбор
Ниже приведены основные техники и приёмы, применённые в работе над задачей. 
Более подробный разбор можно посмотреть по ссылке:
https://github.com/NikiforovHub/CupIT2023VK/blob/main/CupIT2023-DS-32%20Bits%20of%20Analytics.pptx
Это презентация, которая предоставлялась для оценки решения команде VK.

## Проверка данных и разведочный анализ
При проверке данных обнаружили:
1. У каждого поста в трейновом датасете есть ровно 5 комментариев. В ранжировании комментариев нет ошибок, т.е. у постов не встречаются комментарии с одинаковым рейтингом.
2. Все данные полные: нет пустых постов или комментариев.
3. Посты и комментарии содержат смайлики, адреса почт, URL сайтов

## Предварительная обработка данных

1. Смайлики (позитивные и грустные) заменены на токены SMILE SAD
2. Почты заменены на токен MAIL
3. Ссылки (http,https,www), отделены друг от друга и заменены на токен URL
4. Ссылки на источники ([1] [2]) и заменены на LINKS

## Токенизация, лемматизация

Для обработки постов и комментариев мы применили ряд методов предобработки текста

1.Токенизация
2.Удаление стоп слов и пунктуаций
3.Стемминг
4.Лемматизация

Однако, наши эксперименты показали, что использование стемминга дает худшие результаты на модели, поэтому мы решили использовать лемматизацию.

## Анализ эмоционального содержания комментариев 
Предварительно, перед построением модели, был проведён анализ эмоционального содержания комментариев.
Для этого с сервиса hugging face была взята модель ‘j-hartmann/emotion-english-distilroberta-base’, которая определяет 6 базовых эмоций, плюс включает нейтральный класс.
После определения эмоций, каждый комментарий был отнесён к своей группе по рангу и внутри группы находились средние значения для эмоций, результат представлен в таблице ниже.
![image](https://github.com/NikiforovHub/CupIT2023VK/assets/14981310/f77d9c79-9de8-47f6-8825-9ddf6d9981f1)

## Модели ранжирования текста

Последовательность построения модели следующая:

1. Ранжировали комментарии при помощи нескольких методов. 
2. Модели валидировались путём разбиения тренировочного датасета на обучающую и валидационную части.
3. Выбрали модели с наибольшей целевой метрикой (NDCG).

Для ранжирования использовали несколько подходов:

Первый подход: векторизация комментариев и текстов затем применение модели машинного обучения. Было использовано два метода:

а) векторизация при помощи Bag of Words (BoW) показала себя как слишком медленная, поэтому модели на ней не строились
б) векторизация при помощи Term Frequency – Inversed Document Frequency, затем применяли несколько моделей: kNN, RidgeRegression, 
LinearDiscriminantAnalysis (LDA), многослойный перцептрон (MLP). Величину метрики NDCG данных моделей можно увидеть на столбчатой диаграмме

![image](https://github.com/NikiforovHub/CupIT2023VK/assets/14981310/017b731b-1b18-43f5-9aeb-8abe0741f3e1)

Второй подход: извлечение трансформерных эмбеддингов, затем применение модели.

Для извлечения эмбеддингов из комментариев использовалась модель paraphrase-MiniLM-L6-v2.Затем на полученных эмбеддингах были применены модели kNN и RidgeClassifier.

Величину метрики NDCG данных моделей и сравнение с предыдущими моделями можно увидеть на столбчатой диаграмме ниже

![image](https://github.com/NikiforovHub/CupIT2023VK/assets/14981310/1ab6991b-c6ec-4f01-9a01-df12e948afe5)

## Модели ранжирования текста

Отдельно отметим, что при прямом использовании методов машинного обучения получалось, что комментарии ранжировались сквозным методом, то есть комментарии одного поста могли, например, получить одинаковые ранги.
 
Поэтому для ранжирования комментариев конечная модель применялась следующим образом:

Для выбранного поста рассчитывались ранги и вероятности принадлежности к рангу для каждого комментария
Находилось математическое ожидание ранга каждого комментария
Комментарии ранжировались в порядке полученного математического ожидания

<b>Итоговое значение метрики NDCG для лучшей модели равно 0.7.</b>

Блокнот с предсказанием для тестового датасета  
[https://github.com/Bugdol/VK/blob/main/cl-cup-it-2023-inference-test.ipynb](https://github.com/NikiforovHub/CupIT2023VK/blob/main/cl-cup-it-2023-inference-test.ipynb)

## Приложение

ZIP-файл с предсказаниями  
https://github.com/NikiforovHub/CupIT2023VK/blob/main/submit.zip

Проверка разных моделей  
[https://github.com/Bugdol/VK/blob/main/cl-cup-it-2023-base.ipynb](https://github.com/NikiforovHub/CupIT2023VK/blob/main/cl-cup-it-2023-base.ipynb)

Очищенный train_data: https://drive.google.com/file/d/1-yLUT_l0D7hwbHzx5nbIK2iihu5-Tv_g/view?usp=sharing
Очищенный test_data: https://drive.google.com/file/d/1NvuUGNDrGPE7mhvufP6pQbouxiEJkxj7/view?usp=sharing
Оставлены только: латиница, точки, запятые, ссылки, которые начинаются с http, https и www, пробелы. Ссылки не отделены от другого текста. Не больше 1 пробела подряд.

Train с выделенными эмоциями
https://drive.google.com/file/d/1IteKR9ZyAEyEqYDZ6srycaU7-7Nkmy7I/view?usp=share_link
